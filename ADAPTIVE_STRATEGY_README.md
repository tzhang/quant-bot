# è‡ªé€‚åº”æ‰§è¡Œç­–ç•¥ (Adaptive Execution Strategy)

## æ¦‚è¿°

è‡ªé€‚åº”æ‰§è¡Œç­–ç•¥æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„å›æµ‹æ‰§è¡Œä¼˜åŒ–ç³»ç»Ÿï¼Œèƒ½å¤Ÿæ ¹æ®ä»»åŠ¡çš„å¤æ‚åº¦å’Œç³»ç»Ÿèµ„æºè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œç­–ç•¥ï¼Œæ˜¾è‘—æå‡å¤§è§„æ¨¡é‡åŒ–å›æµ‹çš„æ€§èƒ½ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ§  æ™ºèƒ½ç­–ç•¥é€‰æ‹©
- **è‡ªåŠ¨åˆ†æ**: æ ¹æ®è‚¡ç¥¨æ•°é‡ã€æ•°æ®é•¿åº¦ã€ç­–ç•¥å¤æ‚åº¦è‡ªåŠ¨è®¡ç®—ä»»åŠ¡å¤æ‚åº¦
- **åŠ¨æ€é€‰æ‹©**: åŸºäºä»»åŠ¡ç‰¹å¾æ™ºèƒ½é€‰æ‹©æœ€ä¼˜æ‰§è¡Œç­–ç•¥
- **æ€§èƒ½å­¦ä¹ **: è®°å½•å†å²æ‰§è¡Œæ€§èƒ½ï¼ŒæŒç»­ä¼˜åŒ–ç­–ç•¥é€‰æ‹©

### ğŸš€ å¤šç§æ‰§è¡Œç­–ç•¥
1. **Sequential (é¡ºåºæ‰§è¡Œ)**: é€‚ç”¨äºå°è§„æ¨¡ä»»åŠ¡ï¼Œå†…å­˜å ç”¨æœ€ä½
2. **Threaded (çº¿ç¨‹å¹¶è¡Œ)**: é€‚ç”¨äºä¸­ç­‰è§„æ¨¡ä»»åŠ¡ï¼Œå¹³è¡¡æ€§èƒ½å’Œèµ„æº
3. **Async (å¼‚æ­¥æ‰§è¡Œ)**: é€‚ç”¨äºå¤§è§„æ¨¡ä»»åŠ¡ï¼Œé«˜æ•ˆå¤„ç†I/Oå¯†é›†å‹æ“ä½œ
4. **Parallel (è¿›ç¨‹å¹¶è¡Œ)**: é€‚ç”¨äºè¶…å¤§è§„æ¨¡ä»»åŠ¡ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPU

### ğŸ“Š æ€§èƒ½ç›‘æ§
- **å®æ—¶ç›‘æ§**: è·Ÿè¸ªæ‰§è¡Œæ—¶é—´ã€å†…å­˜ä½¿ç”¨ã€CPUåˆ©ç”¨ç‡
- **æ€§èƒ½åˆ†æ**: æä¾›è¯¦ç»†çš„æ€§èƒ½æŠ¥å‘Šå’Œä¼˜åŒ–å»ºè®®
- **åŸºå‡†æµ‹è¯•**: å»ºç«‹ä¸åŒè§„æ¨¡ä»»åŠ¡çš„æ€§èƒ½åŸºå‡†

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```python
from backtesting.enhanced_backtest_engine import ParallelBacktestEngine
from backtesting.adaptive_execution_strategy import AdaptiveExecutionStrategy

# åˆ›å»ºå¹¶è¡Œå›æµ‹å¼•æ“ï¼ˆè‡ªåŠ¨é›†æˆè‡ªé€‚åº”ç­–ç•¥ï¼‰
engine = ParallelBacktestEngine()

# æ·»åŠ å›æµ‹å¼•æ“å’Œç­–ç•¥
for symbol, data in market_data.items():
    backtest_engine = EnhancedBacktestEngine()
    backtest_engine.set_market_data(symbol, data)
    backtest_engine.add_strategy(your_strategy)
    engine.add_engine(symbol, backtest_engine)

# æ‰§è¡Œå›æµ‹ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥ï¼‰
results = engine.run_parallel_backtest(start_date, end_date)
```

### é«˜çº§é…ç½®

```python
from backtesting.adaptive_execution_strategy import (
    AdaptiveExecutionStrategy, 
    PerformanceThreshold
)

# è‡ªå®šä¹‰æ€§èƒ½é˜ˆå€¼
thresholds = PerformanceThreshold(
    small_task_limit=500,      # å°ä»»åŠ¡é˜ˆå€¼
    medium_task_limit=2000,    # ä¸­ç­‰ä»»åŠ¡é˜ˆå€¼
    large_task_limit=10000,    # å¤§ä»»åŠ¡é˜ˆå€¼
    memory_limit_mb=2000.0,    # å†…å­˜é™åˆ¶
    cpu_cores=8                # CPUæ ¸å¿ƒæ•°
)

# åˆ›å»ºè‡ªé€‚åº”ç­–ç•¥
adaptive_strategy = AdaptiveExecutionStrategy(thresholds)

# æ‰‹åŠ¨è®¡ç®—ä»»åŠ¡å¤æ‚åº¦
task_metrics = adaptive_strategy.calculate_task_complexity(
    num_symbols=50,
    data_length=252,
    num_strategies=2
)

# è·å–æ¨èç­–ç•¥
recommended_strategy = adaptive_strategy.choose_execution_strategy(task_metrics)
print(f"æ¨èç­–ç•¥: {recommended_strategy.value}")
```

## æ€§èƒ½åŸºå‡†

åŸºäºæµ‹è¯•ç»“æœï¼Œä»¥ä¸‹æ˜¯ä¸åŒè§„æ¨¡ä»»åŠ¡çš„æ€§èƒ½è¡¨ç°ï¼š

### æ‰§è¡Œæ—¶é—´å¯¹æ¯”

| ä»»åŠ¡è§„æ¨¡ | è‚¡ç¥¨æ•°é‡ | æ•°æ®å¤©æ•° | å¤æ‚åº¦ | æ¨èç­–ç•¥ | æ‰§è¡Œæ—¶é—´ | æˆåŠŸç‡ |
|---------|---------|---------|--------|----------|----------|--------|
| å°è§„æ¨¡   | 5       | 100     | 500    | sequential | 0.04s   | 100%   |
| ä¸­è§„æ¨¡   | 10      | 252     | 2,520  | threaded   | 0.23s   | 100%   |
| å¤§è§„æ¨¡   | 20      | 252     | 5,040  | async      | 0.46s   | 100%   |
| è¶…å¤§è§„æ¨¡ | 50      | 252     | 12,600 | async      | 1.14s   | 100%   |

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–

| ä»»åŠ¡è§„æ¨¡ | è‚¡ç¥¨æ•°é‡ | å³°å€¼å†…å­˜ | å†…å­˜å¢é•¿ | å†…å­˜æ•ˆç‡ |
|---------|---------|----------|----------|----------|
| åŸºå‡†æµ‹è¯• | 10      | 105.5 MB | 9.9 MB   | 0.09 è‚¡ç¥¨/MB |
| ä¸­ç­‰è§„æ¨¡ | 25      | 128.8 MB | 22.4 MB  | 0.19 è‚¡ç¥¨/MB |
| å¤§è§„æ¨¡   | 50      | 148.2 MB | 24.3 MB  | 0.34 è‚¡ç¥¨/MB |
| è¶…å¤§è§„æ¨¡ | 100     | 178.7 MB | 38.4 MB  | 0.56 è‚¡ç¥¨/MB |

## ç­–ç•¥é€‰æ‹©é€»è¾‘

### å¤æ‚åº¦è®¡ç®—å…¬å¼

```
å¤æ‚åº¦ = è‚¡ç¥¨æ•°é‡ Ã— æ•°æ®é•¿åº¦ Ã— ç­–ç•¥å¤æ‚åº¦ç³»æ•°
å†…å­˜ä¼°ç®— = (è‚¡ç¥¨æ•°é‡ Ã— æ•°æ®é•¿åº¦ Ã— 8å­—èŠ‚) / (1024 Ã— 1024) MB
```

### ç­–ç•¥é€‰æ‹©è§„åˆ™

1. **Sequential**: å¤æ‚åº¦ < 1,000 æˆ– å†…å­˜ < 100MB
2. **Threaded**: 1,000 â‰¤ å¤æ‚åº¦ < 5,000 ä¸” å†…å­˜ < 500MB
3. **Async**: 5,000 â‰¤ å¤æ‚åº¦ < 20,000 ä¸” å†…å­˜ < 1000MB
4. **Parallel**: å¤æ‚åº¦ â‰¥ 20,000 æˆ– å†…å­˜ â‰¥ 1000MB

## å†…å­˜ä¼˜åŒ–å»ºè®®

### æ•°æ®ç±»å‹ä¼˜åŒ–
- ä½¿ç”¨ `float32` æ›¿ä»£ `float64` å¯èŠ‚çœçº¦50%å†…å­˜
- ä½¿ç”¨ `int32` æ›¿ä»£ `int64` é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯
- åˆç†é€‰æ‹©æ•°æ®ç²¾åº¦ï¼Œé¿å…è¿‡åº¦ç²¾ç¡®

### å¤„ç†ç­–ç•¥ä¼˜åŒ–
- **åˆ†æ‰¹å¤„ç†**: å¤§æ•°æ®é›†åˆ†å—å¤„ç†ï¼Œé¿å…å†…å­˜å³°å€¼
- **åŠæ—¶æ¸…ç†**: ä½¿ç”¨ `gc.collect()` åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¯¹è±¡
- **æµå¼å¤„ç†**: è€ƒè™‘ä½¿ç”¨æ•°æ®æµå¤„ç†è€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½

### ç³»ç»Ÿé…ç½®ä¼˜åŒ–
- **å†…å­˜é™åˆ¶**: æ ¹æ®ç³»ç»Ÿå†…å­˜åˆç†è®¾ç½® `memory_limit_mb`
- **CPUæ ¸å¿ƒ**: æ ¹æ®å®é™…CPUæ ¸å¿ƒæ•°è®¾ç½® `cpu_cores`
- **å¹¶å‘æ§åˆ¶**: é¿å…è¿‡åº¦å¹¶å‘å¯¼è‡´ç³»ç»Ÿèµ„æºç«äº‰

## æµ‹è¯•å’ŒéªŒè¯

### è¿è¡ŒåŸºæœ¬æµ‹è¯•

```bash
# åŸºæœ¬åŠŸèƒ½æµ‹è¯•
python test_adaptive_strategy.py

# å¤§è§„æ¨¡æ€§èƒ½æµ‹è¯•
python test_simple_large_scale.py

# å†…å­˜ä¼˜åŒ–æµ‹è¯•
python memory_optimization_test.py
```

### è‡ªå®šä¹‰æµ‹è¯•

```python
# åˆ›å»ºè‡ªå®šä¹‰æµ‹è¯•åœºæ™¯
def custom_test():
    engine = ParallelBacktestEngine()
    
    # æ·»åŠ ä½ çš„æ•°æ®å’Œç­–ç•¥
    # ...
    
    # æ‰§è¡Œå›æµ‹
    results = engine.run_parallel_backtest(start_date, end_date)
    
    # åˆ†ææ€§èƒ½
    adaptive_strategy = engine.adaptive_strategy
    performance_history = adaptive_strategy.performance_history
    
    return results, performance_history
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä¸è¶³é”™è¯¯**
   - å‡å°‘æ‰¹å¤„ç†å¤§å°
   - ä½¿ç”¨æ›´èŠ‚çœå†…å­˜çš„æ•°æ®ç±»å‹
   - å¢åŠ ç³»ç»Ÿå†…å­˜æˆ–ä½¿ç”¨åˆ†å¸ƒå¼å¤„ç†

2. **æ‰§è¡Œæ—¶é—´è¿‡é•¿**
   - æ£€æŸ¥ä»»åŠ¡å¤æ‚åº¦è®¡ç®—æ˜¯å¦åˆç†
   - éªŒè¯é€‰æ‹©çš„æ‰§è¡Œç­–ç•¥æ˜¯å¦æœ€ä¼˜
   - è€ƒè™‘ä¼˜åŒ–ç­–ç•¥ç®—æ³•æœ¬èº«

3. **ç­–ç•¥é€‰æ‹©ä¸å½“**
   - è°ƒæ•´æ€§èƒ½é˜ˆå€¼é…ç½®
   - æ£€æŸ¥å†å²æ€§èƒ½æ•°æ®
   - æ‰‹åŠ¨æŒ‡å®šæ‰§è¡Œç­–ç•¥è¿›è¡Œå¯¹æ¯”

### æ€§èƒ½è°ƒä¼˜

1. **é˜ˆå€¼è°ƒæ•´**: æ ¹æ®å®é™…ç¡¬ä»¶æ€§èƒ½è°ƒæ•´ `PerformanceThreshold`
2. **ç­–ç•¥ä¼˜åŒ–**: åŸºäºå†å²æ€§èƒ½æ•°æ®ä¼˜åŒ–ç­–ç•¥é€‰æ‹©é€»è¾‘
3. **èµ„æºç›‘æ§**: ä½¿ç”¨ç³»ç»Ÿç›‘æ§å·¥å…·è§‚å¯Ÿèµ„æºä½¿ç”¨æƒ…å†µ

## æœªæ¥å‘å±•

### è®¡åˆ’åŠŸèƒ½
- **æœºå™¨å­¦ä¹ ä¼˜åŒ–**: ä½¿ç”¨MLç®—æ³•ä¼˜åŒ–ç­–ç•¥é€‰æ‹©
- **åˆ†å¸ƒå¼æ”¯æŒ**: æ”¯æŒè·¨æœºå™¨çš„åˆ†å¸ƒå¼å›æµ‹
- **å®æ—¶ç›‘æ§**: æä¾›Webç•Œé¢çš„å®æ—¶æ€§èƒ½ç›‘æ§
- **è‡ªåŠ¨è°ƒä¼˜**: åŸºäºå†å²æ•°æ®è‡ªåŠ¨è°ƒæ•´å‚æ•°

### è´¡çŒ®æŒ‡å—
æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è‡ªé€‚åº”æ‰§è¡Œç­–ç•¥ç³»ç»Ÿã€‚

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚