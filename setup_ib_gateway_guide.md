# IB Gateway 设置指南

## 📋 概述

Interactive Brokers Gateway (IB Gateway) 是一个轻量级的API服务器，专门用于程序化交易和数据获取。相比TWS (Trader Workstation)，Gateway更适合自动化交易系统。

## 🚀 安装和设置步骤

### 1. 下载和安装 IB Gateway

1. 访问 [Interactive Brokers 官网](https://www.interactivebrokers.com/)
2. 登录您的账户
3. 下载 **IB Gateway** (不是TWS)
   - macOS: 下载 `.dmg` 文件
   - Windows: 下载 `.exe` 文件
   - Linux: 下载 `.sh` 文件

### 2. 启动 IB Gateway

1. **运行 IB Gateway 应用程序**
2. **登录您的IB账户**
   - 输入用户名和密码
   - 如果启用了双因素认证，完成验证

3. **选择交易模式**
   - **模拟交易 (Paper Trading)**: 用于测试，端口 4001
   - **真实交易 (Live Trading)**: 用于实际交易，端口 4000

### 3. 配置 API 设置

#### 在 IB Gateway 中配置:

1. **启动后，Gateway会显示一个小窗口**
2. **点击设置图标 (齿轮图标)**
3. **在 API 设置中:**
   - ✅ **启用 "Enable ActiveX and Socket Clients"**
   - ❌ **取消勾选 "Read-Only API"** (如果需要交易功能)
   - **设置端口:**
     - 模拟交易: `4001`
     - 真实交易: `4000`
   - **添加信任的IP地址:** `127.0.0.1`
   - **设置客户端ID范围:** 例如 `1-100`

4. **点击 "OK" 保存设置**

### 4. 验证连接

运行我们的测试脚本来验证连接:

```bash
python test_ib_gateway_connection.py
```

如果看到以下输出，说明连接成功:
```
✅ 端口 4001 可用 - IB Gateway 模拟交易
✅ IB Gateway API连接成功
```

## 🔧 常见问题和解决方案

### 问题 1: 端口连接失败

**症状:** `❌ 端口 4001 不可用 - IB Gateway 模拟交易`

**解决方案:**
1. **确认 IB Gateway 已启动并完全登录**
2. **检查 API 设置是否正确启用**
3. **重启 IB Gateway**
4. **检查防火墙设置**

### 问题 2: API 连接超时

**症状:** `❌ IB Gateway API连接超时`

**解决方案:**
1. **增加客户端ID** (避免冲突)
2. **检查网络连接**
3. **确认没有其他程序占用相同的客户端ID**

### 问题 3: 市场数据订阅失败

**症状:** `市场数据需要订阅 [10089]`

**解决方案:**
1. **确认您的IB账户有市场数据订阅**
2. **在IB账户管理中购买所需的市场数据**
3. **使用模拟交易模式进行测试**

## 📊 端口配置说明

| 服务 | 模式 | 端口 | 用途 |
|------|------|------|------|
| IB Gateway | 模拟交易 | 4001 | 测试和开发 |
| IB Gateway | 真实交易 | 4000 | 生产环境 |
| TWS | 模拟交易 | 7497 | 图形界面测试 |
| TWS | 真实交易 | 7496 | 图形界面交易 |

## 🎯 推荐配置

### 开发和测试环境
```python
IB_HOST = "127.0.0.1"
IB_PORT = 4001  # 模拟交易
IB_CLIENT_ID = 1
```

### 生产环境
```python
IB_HOST = "127.0.0.1"
IB_PORT = 4000  # 真实交易
IB_CLIENT_ID = 1
```

## ⚠️ 重要注意事项

1. **模拟交易优先**: 始终先在模拟交易环境中测试您的策略
2. **客户端ID唯一性**: 每个连接需要使用不同的客户端ID
3. **市场数据订阅**: 真实交易需要相应的市场数据订阅
4. **风险管理**: 在生产环境中设置适当的风险控制参数
5. **连接稳定性**: Gateway 需要保持运行状态以维持API连接

## 🔄 下一步

一旦 IB Gateway 连接成功，您可以:

1. **运行真实数据监控面板**
2. **配置交易策略**
3. **设置风险管理参数**
4. **开始程序化交易**

## 📞 获取帮助

如果遇到问题:
1. 查看 IB Gateway 日志文件
2. 检查 Interactive Brokers 官方文档
3. 联系 IB 技术支持
4. 运行我们的诊断脚本获取详细信息

---

**准备好后，请启动 IB Gateway 并运行测试脚本验证连接！**